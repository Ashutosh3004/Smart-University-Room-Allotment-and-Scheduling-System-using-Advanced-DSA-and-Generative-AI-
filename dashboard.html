<!DOCTYPE html>
<html lang="en">
<head>
<title>Student Dashboard - View & Request</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="style.css"> 
<style>
/* Custom Layout for the Dashboard */
.dashboard-layout {
    display: grid;
    grid-template-columns: 370px 1fr; 
    gap: 20px;
    padding: 20px;
    margin-top: 50px;
}
.filter-bar {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    align-items: center;
    margin-bottom: 20px;
}
#scheduleTable table { width: 100%; border-collapse: collapse; margin-top: 15px; }
#scheduleTable th, #scheduleTable td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
.card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.w3-red-theme { background-color: #cc0000 !important; color: white !important; }
</style>
</head>
<body>

<div class="w3-top">
  <div class="w3-bar w3-red-theme w3-card w3-left-align w3-large">
    <a href="index.html" class="w3-bar-item w3-button w3-padding-large w3-hover-white">Home</a>
    <a href="student-login.html" class="w3-bar-item w3-button w3-padding-large w3-white">Student View</a>
  </div>
</div>

<div class="dashboard-layout">
    
    <div class="card">
        <h3 class="w3-text-red-theme" style="color: #cc0000 !important;">Submit Booking Request</h3>
        <p class="w3-text-grey w3-small">Use natural language to submit your room request for Admin approval.</p>

        <label>Your Name</label>
        <input id="userName" placeholder="Student Name" class="w3-input w3-border w3-round-large" required>
        
        <label style="margin-top: 15px;">AI Command Prompt</label>
        <textarea id="aiPrompt" rows="3" placeholder="e.g., 'Request B101 for tomorrow from 10:00 to 12:00'" class="w3-input w3-border w3-round-large" required></textarea>

        <button id="processRequestBtn" class="w3-button w3-block w3-red-theme w3-round-large w3-margin-top">Process Request</button>
        
        <div id="requestResult" class="w3-panel w3-margin-top w3-small"></div>
    </div>
  
    <div>
        <div class="w3-container w3-padding-16">
            <h1 style="color: #cc0000;">University Schedule Dashboard</h1>
            <p class="w3-text-grey">Real-time room availability.</p>
        </div>

        <div class="filter-bar">
            <label>Filter by Room:</label>
            <select id="filterRoom" class="w3-select w3-border w3-round-large" style="width: 200px;"></select>
            <button id="applyFilterBtn" class="w3-button w3-red-theme w3-round-large">Apply Filter</button>
            <button id="refreshScheduleBtn" class="w3-button w3-light-grey w3-round-large">Refresh</button>
        </div>

        <div class="card">
            <h3 style="color: #cc0000;">Current Room Utilization</h3>
            <div id="scheduleTable">
                <p class="w3-text-grey" id="loadingMessage">Loading schedule from server...</p>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = 'http://localhost:5000/api/schedule';

let currentSchedule = [];
let availableRooms = [];
const currentRole = 'student'; // Hardcoded for Student Dashboard

function fetchSchedule() {
    fetch(`${API_BASE_URL}/view`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // CRITICAL: Sync variable names with backend
                currentSchedule = data.schedule; 
                availableRooms = data.rooms;
                
                populateRoomFilter(availableRooms);
                renderScheduleTable(currentSchedule, document.getElementById('filterRoom').value); 
                
                const loader = document.getElementById('loadingMessage');
                if(loader) loader.style.display = 'none';
            }
        })
        .catch(err => {
            document.getElementById('scheduleTable').innerHTML = '<p style="color:red">❌ Connection Error. Ensure server is running.</p>';
        });
}

function populateRoomFilter(rooms) {
    const select = document.getElementById('filterRoom');
    select.innerHTML = '<option value="all" selected>All Rooms</option>'; 
    rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = room.name;
        select.appendChild(option);
    });
}

function renderScheduleTable(scheduleData, filterRoomId) {
    const container = document.getElementById('scheduleTable');
    let filteredData = scheduleData;
    
    if (filterRoomId && filterRoomId !== 'all') {
        filteredData = scheduleData.filter(b => b.room_id === filterRoomId);
    }
    
    if (filteredData.length === 0) {
        container.innerHTML = `<p class="w3-text-grey">No bookings found for the selected criteria. Try refreshing.</p>`;
        return;
    }

    let tableHtml = '<table><thead><tr><th>Room</th><th>Time Slot</th><th>Date</th><th>Booked By</th><th>Role</th></tr></thead><tbody>';

    filteredData.forEach(booking => {
        // CRITICAL FIX: Use keys matching api_server.py (start_time, end_time, user_role)
        const roomName = availableRooms.find(r => r.id === booking.room_id)?.name || booking.room_id;
        
        let roleClass = 'w3-tag w3-light-grey';
        if (booking.user_role === 'admin') roleClass = 'w3-tag w3-blue';
        if (booking.user_role === 'faculty') roleClass = 'w3-tag w3-green';

        tableHtml += `
            <tr>
                <td><strong>${roomName}</strong></td>
                <td>${booking.start_time} - ${booking.end_time}</td>
                <td>${booking.date}</td>
                <td>${booking.user_name}</td>
                <td><span class="${roleClass}">${booking.user_role ? booking.user_role.toUpperCase() : 'N/A'}</span></td>
            </tr>`;
    });
    
    tableHtml += '</tbody></table>';
    container.innerHTML = tableHtml;
}

// --- STUDENT REQUEST HANDLER ---
document.getElementById('processRequestBtn').addEventListener('click', async () => {
    const user_prompt = document.getElementById('aiPrompt').value.trim();
    const user_name = document.getElementById('userName').value.trim(); 
    const resultEl = document.getElementById('requestResult');

    if (!user_prompt || !user_name) {
        resultEl.innerHTML = '<div style="color:red">Error: Name and AI Command must be filled.</div>';
        return;
    }
    
    // Use the AI Workflow route logic
    const payload = {
        prompt: user_prompt,
        user_role: currentRole, 
        user_name: user_name
    };
    
    try {
        resultEl.innerHTML = '<div style="color:blue">Processing...</div>';
        
        const response = await fetch(`${API_BASE_URL}/ai-workflow`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (data.status === 'success') {
            resultEl.innerHTML = `<div style="color:green; font-weight:bold;">✅ ${data.message}</div>`;
        } else if (data.status === 'conflict_request') {
            // Show suggestions
            const suggestionText = data.suggestion_text || 'No suggestions available.';
            resultEl.innerHTML = `<div style="color:orange; font-weight:bold;">⚠️ ${data.message}<br><br>Suggestion: ${suggestionText}</div>`;
        } else {
            resultEl.innerHTML = `<div style="color:red;">❌ ${data.message}</div>`;
        }
        
        fetchSchedule(); // Refresh list
        
    } catch (error) {
        resultEl.innerHTML = `<div style="color:red">❌ Connection Error.</div>`;
    }
});

document.getElementById('applyFilterBtn').addEventListener('click', () => {
    const selectedRoomId = document.getElementById('filterRoom').value;
    renderScheduleTable(currentSchedule, selectedRoomId);
});

document.getElementById('refreshScheduleBtn').addEventListener('click', () => {
    fetchSchedule();
});

document.addEventListener('DOMContentLoaded', () => {
    fetchSchedule();
});
</script>
</body>
</html>
