<!DOCTYPE html>
<html lang="en">
<head>
<title>AI Control Center - Smart Room Allotment System</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="style.css"> 
<style>
/* Custom Layout for the Control Panel */
.layout-control {
    display: grid;
    grid-template-columns: 370px 1fr;
    gap: 20px;
    padding: 20px;
    margin-top: 50px; /* Space for fixed navbar */
}
.card {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.section-title { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.controls-row { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }

/* Styles needed by JS (Placeholder if style.css is not linked) */
.priority-badge { display: inline-block; padding: 3px 6px; border-radius: 4px; font-size: 10px; color: white; }
.p-admin { background: blue; } .p-fac { background: green; }
.result-assigned { background: #d4edda; color: #155724; padding: 8px; border-radius: 5px; }
.result-unassigned { background: #f8d7da; color: #721c24; padding: 8px; border-radius: 5px; }
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
.stat-box { border-left: 4px solid red; padding: 10px; background: #f9f9f9; }
</style>
</head>
<body>

<div class="w3-top">
  <div class="w3-bar w3-red w3-card w3-left-align w3-large">
    <a href="index.html" class="w3-bar-item w3-button w3-padding-large w3-white">Home (Marketing)</a>
    <a href="login.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Switch Role</a>
    <a href="dashboard.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">View Schedule</a> 
    <a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-red" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
  </div>
</div>

<div class="layout-control">
  <div>
    <div class="card">
      <h3 class="section-title">Natural Language Scheduler</h3>
      
      <label>User Name (For Booking)</label>
      <input id="userName" placeholder="Admin/Faculty Name" required>
      
      <label style="margin-top: 20px;">AI Command Prompt</label>
      <textarea id="aiPrompt" rows="4" placeholder="e.g., 'Book Classroom B101 for tomorrow from 10:00 to 12:00 for a seminar.'" class="w3-input w3-border" required></textarea>

      <div class="controls-row" style="margin-top: 15px;">
        <button id="processCommandBtn" style="background: #0056b3; width: 100%; font-weight: bold;">Process AI Command</button> 
      </div>

      <div id="allotResult" style="margin-top: 10px;"></div>
    </div>
    
    <div class="card" style="margin-top: 15px;">
      <h3 class="section-title">Available Rooms (Dataset)</h3>
      <div id="roomsList"></div> 
      <div class="controls-row">
          <button id="seedRoomsBtn" style="width: 100%;">Reload Room Data</button>
      </div>
    </div>
  </div>

  <div>
    <div class="card">
        <h3 class="section-title">System Metrics</h3>
        <div class="stats-grid">
            <div class="stat-box">
                <div id="statRoomCount">0</div>
                <small>Total Rooms</small>
            </div>
            <div class="stat-box">
                <div id="statAssignedPercent">0%</div>
                <small>Room Utilization (Simulated)</small>
            </div>
            <div class="stat-box">
                <div id="statClashTime">0</div>
                <small>Booked Slots</small>
            </div>
        </div>
        <div class="controls-row">
             <button id="clearAssigned" style="background: red;">Clear Schedule</button> 
        </div>
    </div>
    <a href="manualbooking.html" class="w3-button w3-red w3-round-large w3-margin">
    Admin Manual Override
    </a>

    <div class="card" style="margin-top: 15px;">
      <h3 class="section-title">Current Schedule (Assigned Bookings)</h3>
      <div id="assignedTable"></div> 
    </div>

    <div class="card" style="margin-top: 15px;">
      <h3 class="section-title">Pending Student Requests</h3>
      <div id="unassignedTable"></div> 
    </div>
  </div>
</div>
<script>
/* -------------------------------------------
  DATA CONSTANTS & UTILITIES (CLEANED AND UNIFIED)
---------------------------------------------*/
const API_BASE_URL = 'http://localhost:5000/api/schedule';

function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// GLOBAL STATE VARIABLES (DECLARED ONCE)
let rooms = [];
let assignments = []; 

// CRITICAL FIX: Get role from URL, default to 'faculty' (most common privileged user)
let currentRole = getQueryParam('role') || 'faculty'; 

function parseTime(dateStr, hhmm){ return new Date(dateStr + 'T' + hhmm + ':00').getTime(); }
function id() { return Math.random().toString(36).substring(2, 9); }
function myFunction() { 
  var x = document.getElementById("navDemo");
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
  } else {
    x.className = x.className.replace(" w3-show", "");
  }
}

// CRITICAL VISUAL FIX: Set the placeholder text based on the actual detected role immediately
// This ensures the input box says "ADMIN Name" or "FACULTY Name" on load.
document.getElementById('userName').placeholder = `${currentRole.toUpperCase()} Name`; 


/* -------------------------
  Render Helpers & Statistics
--------------------------*/
function renderRooms(){ 
    const el = document.getElementById('roomsList'); el.innerHTML='';
    if (rooms.length === 0) {
        el.innerHTML = '<div style="color:red; font-weight:bold;">No rooms found in dataset.</div>';
        return;
    }
    let html = '<table><thead><tr><th>Name</th><th>ID</th></tr></thead><tbody>';
    rooms.forEach(r=>{
        html += `<tr><td><strong>${r.name}</strong></td><td>${r.id}</td></tr>`;
    });
    html += '</tbody></table>';
    el.innerHTML = html;
}

function renderSchedule(scheduleData) {
    const el = document.getElementById('assignedTable'); el.innerHTML = '';
    
    if (!scheduleData || scheduleData.length === 0) {
        el.innerHTML = '<div class="muted small">No scheduled bookings yet.</div>';
        return;
    }

    let rows = scheduleData.map(b => {
        const room = rooms.find(r => r.id === b.room_id) || { name: 'Unknown Room' };
        
        // FIX 1: Use 'user_role' key for display and color
        const priorityColor = (b.user_role === 'admin') ? 'p-admin' : (b.user_role === 'faculty') ? 'p-fac' : 'p-student';

        // FIX 2 & 3: Correctly display Time and Booked By Name (keys are now correct)
        return `
            <tr class="assigned-row">
                <td><strong>${room.name}</strong></td>
                <td>${b.start_time} - ${b.end_time}</td> 
                <td><span class="priority-badge ${priorityColor}">${b.user_role}</span></td>
                <td>${b.user_name}</td> 
            </tr>`;
    }).join('');

    let html = '<table><thead><tr><th>Room</th><th>Time Slot</th><th>Role</th><th>Booked By</th></tr></thead><tbody>';
    html += rows;
    el.innerHTML = html + '</tbody></table>';
    
    assignments = scheduleData;
}

function renderUnassigned(requestQueueLength) {
    const el = document.getElementById('unassignedTable');
    el.innerHTML = `<div class="w3-small">Total Pending Student Requests: <strong>${requestQueueLength}</strong></div>`;
}

function updateStats(){
    const totalRooms = rooms.length;
    const assignedCount = assignments.length; 
    
    const successRate = totalRooms > 0 ? ((assignedCount / totalRooms) * 100).toFixed(1) : 0;
    const totalBookedSlots = assignedCount;

    document.getElementById('statRoomCount').textContent = totalRooms.toString();
    document.getElementById('statAssignedPercent').textContent = `${successRate}%`;
    document.getElementById('statClashTime').textContent = `${totalBookedSlots}`; 
}

function refreshSchedule() {
    fetch(`${API_BASE_URL}/view`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                rooms = data.rooms; 
                renderRooms(); 
                renderSchedule(data.schedule); 
                updateStats(); 
                const requestQueueLength = data.requests_queue_length || 0; 
                renderUnassigned(requestQueueLength); 
            }
        })
        .catch(err => {
            document.getElementById('assignedTable').innerHTML = '<div style="color:red;">❌ Connection Error: Server may be down.</div>';
        });
}


/* -------------------------
  API INTERACTION HANDLERS (AI COMMAND WORKFLOW)
--------------------------*/

document.getElementById('processCommandBtn').addEventListener('click', async ()=>{
    const user_prompt = document.getElementById('aiPrompt').value.trim();
    const user_name = document.getElementById('userName').value.trim(); 
    const resultEl = document.getElementById('allotResult');

    if (!user_prompt || !user_name) {
        resultEl.innerHTML = '<div class="result-unassigned">Error: User Name and AI Command must be filled.</div>';
        return;
    }
    
    // 1. Prepare Payload for AI Workflow
    const payload = {
        prompt: user_prompt,
        user_role: currentRole, 
        user_name: user_name
    };
    
    try {
        // 2. Call the unified AI Workflow route
        const response = await fetch(`${API_BASE_URL}/ai-workflow`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        const data = await response.json();

        // 3. Handle Responses
        if (data.status === 'success') {
            resultEl.innerHTML = `<div class="result-assigned">✅ **AI-Parsed Command Executed:** ${data.message}</div>`;
        } else if (data.status === 'conflict' || data.status === 'conflict_request') {
            // CRITICAL: Retrieve the fully generated suggestion text
            const suggestionText = data.suggestion_text || 'No detailed AI analysis available.';
            
            resultEl.innerHTML = `<div class="result-unassigned">
                ⚠️ **CONFLICT/REQUEST FAILURE:** ${data.message} <br>
                <span style="font-weight: 600;">AI Analysis:</span> ${suggestionText}
            </div>`;
        } else {
            // Catches AI parsing failures or other general errors
            resultEl.innerHTML = `<div class="result-unassigned">❌ SYSTEM/AI ERROR: ${data.message}</div>`;
        }
        
        refreshSchedule(); 
        
    } catch (error) {
        console.error('API Error:', error);
        resultEl.innerHTML = `<div class="result-unassigned">❌ Connection Error. Is the server running?</div>`;
    }
});


// --- Placeholder handlers ---
document.getElementById('seedRoomsBtn').addEventListener('click', ()=>{
    refreshSchedule();
});

document.getElementById('clearAssigned').addEventListener('click', async ()=>{
    const resultEl = document.getElementById('allotResult');
    try {
        const response = await fetch(`${API_BASE_URL}/clear`, { method: 'POST' });
        const data = await response.json();
        resultEl.innerHTML = `<div class="result-assigned">✅ ${data.message}</div>`;
        refreshSchedule(); 
    } catch (error) {
        resultEl.innerHTML = `<div class="result-unassigned">❌ Failed to clear schedule.</div>`;
    }
});


/* Initial Load */
document.addEventListener('DOMContentLoaded', () => {
    refreshSchedule();
});
</script>

</body>
</html>